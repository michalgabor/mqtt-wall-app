!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=c.WallClient=function(){function a(b,c,e){var f=this,g=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;d(this,a),this.username=c,this.password=e,this.qos=g,this.clientId=a.generateClientId(),this.client=new Paho.MQTT.Client(b,this.clientId),this.client.onMessageArrived=function(a){f.onMessage(a.destinationName,a.payloadString,a.retained,a.qos)},this.client.onConnectionLost=function(b){return console.info("Connection lost ",b),a.isNetworkError(b.errorCode)?void f._reconnect():void f.onError("Connection lost ("+b.errorMessage+")",!0)},this.currentTopic=null,this.onConnected=$.noop(),this.onMessage=$.noop(),this.onError=$.noop(),this.onStateChanged=$.noop(),this.firstConnection=!0,this.attempts=0,this._setState(a.STATE.NEW)}return e(a,[{key:"subscribe",value:function(a,b){var c=this;if(null!==this.currentTopic&&this.currentTopic!==a){var d=this.currentTopic;this.client.unsubscribe(d,{onSuccess:function(){console.info("Unsubscribe '%s' success",d)},onFailure:function(a){console.error("Unsubscribe '%s' failure",d,a)}})}this.client.subscribe(a,{qos:this.qos,onSuccess:function(c){console.info("Subscribe '%s' success",a,c),b&&b()},onFailure:function(b){console.error("subscribe '%s' failure",a,b),c.onError("Subscribe failure")}}),this.currentTopic=a}},{key:"connect",value:function(){var b=this,c={onSuccess:function(){console.info("Connect success"),b.attempts=0,b._setState(a.STATE.CONNECTED),b.firstConnection?(b.firstConnection=!1,b.onConnected()):b.subscribe(b.currentTopic)},onFailure:function(c){return console.error("Connect fail ",c),a.isNetworkError(c.errorCode)?void b._reconnect():void b.onError("Fail to connect",!0)}};this.username&&this.password&&(c.userName=this.username,c.password=this.password),this._setState(this.firstConnection?a.STATE.CONNECTING:a.STATE.RECONNECTING),this.client.connect(c)}},{key:"_reconnect",value:function(){var b=this;this.attempts++,this._setState(this.firstConnection?a.STATE.CONNECTING:a.STATE.RECONNECTING);var c=2e3*(this.attempts-1);c=Math.max(Math.min(c,3e4),100),setTimeout(function(){b.connect()},c)}},{key:"_setState",value:function(a){this.state=a,this.onStateChanged&&this.onStateChanged(a)}},{key:"toString",value:function(){return this.client._getURI()}}],[{key:"generateClientId",value:function(){var a=Date.now()%1e3,b=Math.round(1e3*Math.random());return"wall"+(1e3*a+b)}},{key:"isNetworkError",value:function(a){var b=[1,2,3,4,6,7,8,9,11,12,15,16,17];return b.indexOf(a)>=0}}]),a}();f.STATE={NEW:0,CONNECTING:1,CONNECTED:2,RECONNECTING:3,ERROR:99}},{}],2:[function(a,b,c){"use strict";function d(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function e(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function f(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0}),c.Toolbar=c.Footer=c.MessageContainer=c.MessageLine=c.UI=void 0;var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./utils.js"),i=a("./client.js"),j=c.UI={};j.setTitle=function(a){document.title="MQTT Wall"+(a?" for "+a:"")},j.toast=function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",c=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new k(a,b,c)};var k=function(){function a(b){var c=this,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];f(this,a),this.$root=$("<div class='toast-item'>").text(b).addClass(d).hide().appendTo("#toast").fadeIn(),e?this.$root.addClass("persistent"):setTimeout(function(){c.hide()},5e3)}return g(a,[{key:"hide",value:function(){var a=this;this.$root.slideUp().queue(function(){a.remove()})}},{key:"remove",value:function(){this.$root.remove()}},{key:"setMessage",value:function(a){this.$root.text(a)}}]),a}(),l=c.MessageLine=function(){function a(b){f(this,a),this.topic=b,this.counter=0,this.isNew=!0,this.init()}return g(a,[{key:"init",value:function(){this.$root=$("<article class='message'>");var a=$("<header>").appendTo(this.$root);$("<h2>").text(this.topic).appendTo(a),window.config.showCounter&&(this.$counterMark=$("<span class='mark counter' title='Message counter'>0</span>").appendTo(a)),this.$retainMark=$("<span class='mark retain' title='Retain message'>R</span>").appendTo(a),this.$qosMark=$("<span class='mark qos' title='Received message QoS'>QoS</span>").appendTo(a),this.$payload=$("<p>").appendTo(this.$root)}},{key:"highlight",value:function(){var a=arguments.length>0&&void 0!==arguments[0]&&arguments[0];(a?this.$root:this.$payload).stop().css({backgroundColor:"#0CB0FF"}).animate({backgroundColor:"#fff"},2e3)}},{key:"update",value:function(a,b,c){this.counter++,this.isRetained=b,this.$counterMark&&this.$counterMark.text(this.counter),this.$qosMark&&(0==c?this.$qosMark.hide():(this.$qosMark.show(),this.$qosMark.text("QoS "+c),this.$qosMark.attr("data-qos",c))),""==a?(a="NULL",this.isSystemPayload=!0):this.isSystemPayload=!1,this.$payload.text(a),this.highlight(this.isNew),this.isNew&&(this.isNew=!1)}},{key:"isRetained",set:function(a){this.$retainMark[a?"show":"hide"]()}},{key:"isSystemPayload",set:function(a){this.$payload.toggleClass("sys",a)}}]),a}(),m=c.MessageContainer=function(){function a(b){f(this,a),this.sort="Alphabetically",this.$parent=b,this.init()}return g(a,[{key:"init",value:function(){this.reset()}},{key:"reset",value:function(){this.lines={},this.topics=[],this.$parent.html("")}},{key:"update",value:function(a,b,c,d){if(!this.lines[a]){var e=new l(a,this.$parent);this["addLine"+this.sort](e),this.lines[a]=e}this.lines[a].update(b,c,d)}},{key:"addLineAlphabetically",value:function(a){if(0==this.topics.length)return void this.addLineChronologically(a);var b=a.topic;this.topics.push(b),this.topics.sort();var c=this.topics.indexOf(b);if(0==c)return void this.$parent.prepend(a.$root);var d=this.topics[c-1];a.$root.insertAfter(this.lines[d].$root)}},{key:"addLineChronologically",value:function(a){this.topics.push(a.topic),this.$parent.append(a.$root)}}]),a}();m.SORT_APLHA="Alphabetically",m.SORT_CHRONO="Chronologically";c.Footer=function(){function a(){f(this,a)}return g(a,[{key:"clientId",set:function(a){$("#status-client").text(a)}},{key:"uri",set:function(a){$("#status-host").text(a)}},{key:"state",set:function(a){var b=void 0,c=void 0;switch(a){case i.WallClient.STATE.NEW:b="",c="connecting";break;case i.WallClient.STATE.CONNECTING:b="connecting...",c="connecting";break;case i.WallClient.STATE.CONNECTED:b="connected",c="connected";break;case i.WallClient.STATE.RECONNECTING:b="reconnecting...",c="connecting";break;case i.WallClient.STATE.ERROR:b="not connected",c="fail";break;default:throw new Error("Unknown WallClient.STATE")}this.reconnectAttempts>1&&(b+=" ("+this.reconnectAttempts+")"),$("#status-state").removeClass().addClass(c),$("#status-state span").text(b)}}]),a}(),c.Toolbar=function(a){function b(a){f(this,b);var c=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.$parent=a,c.$topic=a.find("#topic"),c.initEventHandlers(),c.initDefaultTopic(),c}return e(b,a),g(b,[{key:"initEventHandlers",value:function(){var a=this,b=!1;this.$topic.keyup(function(c){13===c.which&&a.$topic.blur(),27===c.keyCode&&(b=!0,a.$topic.blur())}),this.$topic.focus(function(a){b=!1}),this.$topic.blur(function(c){b?a.updateUi():a.inputChanged()})}},{key:"inputChanged",value:function(){var a=this.$topic.val();a!==this._topic&&(this._topic=a,this.emit("topic",a))}},{key:"initDefaultTopic",value:function(){""!==location.hash?this._topic=location.hash.substr(1):this._topic=config.defaultTopic||"/#",this.updateUi()}},{key:"updateUi",value:function(){this.$topic.val(this._topic)}},{key:"topic",get:function(){return this._topic},set:function(a){this._topic=a,this.updateUi(),this.emit("topic",a)}}]),b}(h.EventEmitter)},{"./client.js":1,"./utils.js":3}],3:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();c.EventEmitter=function(){function a(){d(this,a)}return e(a,[{key:"on",value:function(a,b){void 0===this["_on"+a]&&(this["_on"+a]=[]),this["_on"+a].push(b)}},{key:"emit",value:function(a){for(var b=this,c=arguments.length,d=Array(c>1?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];this["_on"+a]&&this["_on"+a].forEach(function(a){return a.apply(b,d)})}}]),a}()},{}],4:[function(a,b,c){"use strict";function d(){var a=k.topic;h.subscribe(a,function(){f.UI.setTitle(a),location.hash="#"+a}),i.reset()}var e=a("./client.js"),f=a("./ui.js"),g=void 0!==config.server.password?atob(config.server.password):void 0,h=new e.WallClient(config.server.uri,config.server.username,g,config.qos),i=new f.MessageContainer($("section.messages")),j=new f.Footer,k=new f.Toolbar($("#header"));i.sort=config.alphabeticalSort?f.MessageContainer.SORT_APLHA:f.MessageContainer.SORT_CHRONO,j.clientId=h.clientId,j.uri=h.toString(),j.state=0,k.on("topic",function(){d()}),h.onConnected=function(){d(),f.UI.toast("Connected to host "+h.toString())},h.onError=function(a,b){f.UI.toast(a,"error",b)};var l=null;h.onStateChanged=function(a){if(j.reconnectAttempts=h.attempts,j.state=a,(a===e.WallClient.STATE.CONNECTING||a===e.WallClient.STATE.RECONNECTING)&&h.attempts>=2){var b=a===e.WallClient.STATE.CONNECTING?"Fail to connect. Trying to connect... ("+h.attempts+" attempts)":"Connection lost. Trying to reconnect... ("+h.attempts+" attempts)";null===l?l=f.UI.toast(b,"error",!0):l.setMessage(b)}a===e.WallClient.STATE.CONNECTED&&null!==l&&(l.hide(),l=null,0==h.firstConnection&&f.UI.toast("Reconnected"))},h.onMessage=function(a,b,c,d){i.update(a,b,c,d)},h.connect()},{"./client.js":1,"./ui.js":2}]},{},[4]);